# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
---
# Octopize Avatar - Authentik Blueprint Template
# This blueprint configures SSO authentication for the Avatar API platform
# including custom flows, stages, policies, and email templates
#
# Required Placeholders (fill before import):
#   avatar.internal.com                - Base domain (e.g., staging.octopize.tech)
#   c199fe03af1cbbb725a1535be7a3427244d67548f289b26822d697fa370161a2             - OAuth2 Client ID
#   7490f4eebbd267692192d2dc04cf061f0eb471cd2ce513a4189a701f55956ea6         - OAuth2 Client Secret
#   https://avatar.internal.com/api/login/sso/auth      - Full redirect URI for API (e.g., https://avatar.internal.com/api/login/sso/auth)
#   demo  - License type for self-service signups (e.g., demo, trial, full)

version: 1
metadata:
  name: octopize-avatar-sso-configuration

context:
  # Configurable values via Context
  domain: !Context [domain, "avatar.internal.com"]
  app_name: !Context [app_name, "Avatar API"]
  license_type: !Context [license_type, "full"]

entries:
  # ========================================
  # GROUPS
  # ========================================

  - model: authentik_core.group
    identifiers:
      name: Octopize - Admins
    attrs:
      name: Octopize - Admins
      is_superuser: true
      attributes:
        license: !Context license_type
    state: present

  - model: authentik_core.group
    identifiers:
      name: Octopize - Users
    attrs:
      name: Octopize - Users
      attributes:
        license: !Context license_type
    state: present

  # ========================================
  # CUSTOM FLOWS
  # ========================================

  - model: authentik_flows.flow
    identifiers:
      slug: avatar-authentication-flow
    attrs:
      name: avatar-authentication-flow
      title: Avatar authentication
      slug: avatar-authentication-flow
      designation: authentication
      authentication: none
      compatibility_mode: true
      denied_action: message_continue
      layout: stacked
      policy_engine_mode: any
    state: present

  - model: authentik_flows.flow
    identifiers:
      slug: avatar-self-service-signup-flow
    attrs:
      name: avatar-self-service-signup-flow
      title: Self-service signup for Avatar
      slug: avatar-self-service-signup-flow
      designation: enrollment
      authentication: none
      compatibility_mode: true
      denied_action: message_continue
      layout: stacked
      policy_engine_mode: any
    state: present

  - model: authentik_flows.flow
    identifiers:
      slug: avatar-recovery-flow
    attrs:
      name: Default recovery flow
      title: Reset your password
      slug: avatar-recovery-flow
      designation: recovery
      authentication: require_unauthenticated
      background: /static/dist/assets/images/flow_background.jpg
      denied_action: message_continue
      layout: stacked
      policy_engine_mode: any
    state: present

  # ========================================
  # POLICIES
  # ========================================

  - model: authentik_policies_expression.expressionpolicy
    identifiers:
      name: avatar-self-service-per-user-organization-creation
    attrs:
      name: avatar-self-service-per-user-organization-creation
      expression: |
        from authentik.core.models import Group
        from authentik.lib.utils.http import get_http_session

        email = request.context.get("prompt_data", {}).get("email") or request.user.email

        if not email:
            ak_logger.warning("No email found in context or user")
            return True

        group_name = f"self_service-{email}"

        # License type is injected from template variable
        self_service_license = "demo"

        group, created = Group.objects.get_or_create(
            name=group_name,
            defaults={
                "attributes": {"license": self_service_license}
            }
        )

        if not created and group.attributes.get("license") != self_service_license:
            group.attributes["license"] = self_service_license
            group.save()

        request.context["flow_plan"].context["groups"] = [group]

        if created:
            ak_logger.info(f"Created new personal group with {self_service_license} license for user: {email}")
        else:
            ak_logger.info(f"Updated existing group attributes for user: {email}")

        return True
    state: present

  - model: authentik_policies_password.passwordpolicy
    identifiers:
      name: avatar-password-length-policy
    attrs:
      name: avatar-password-length-policy
      password_field: password
      amount_digits: 0
      amount_lowercase: 0
      amount_symbols: 0
      amount_uppercase: 0
      check_static_rules: true
      error_message: Password must be at least 12 characters long.
      hibp_allowed_count: 0
      length_min: 12
      symbol_charset: '!"#$%&''()*+,-./:;<=>?@[]^_`{|}~'
      zxcvbn_score_threshold: 2
    state: present

  # ========================================
  # EMAIL STAGES
  # ========================================

  - model: authentik_stages_email.emailstage
    identifiers:
      name: avatar-email-someone-tried-to-register-with-your-mail
    attrs:
      name: avatar-email-someone-tried-to-register-with-your-mail
      subject: Someone tried to register with your mail
      template: custom/email_account_exists.html
      from_address: system@authentik.local
      host: localhost
      port: 25
      use_global_settings: true
      timeout: 10
      token_expiry: minutes=0
      recovery_cache_timeout: minutes=5
      recovery_max_attempts: 5
    state: present

  - model: authentik_stages_email.emailstage
    identifiers:
      name: avatar-email-account-confirmation
    attrs:
      name: avatar-email-account-confirmation
      subject: Avatar - Account confirmation
      template: custom/email_account_confirmation.html
      activate_user_on_success: true
      from_address: system@authentik.local
      host: localhost
      port: 25
      use_global_settings: true
      timeout: 10
      token_expiry: hours=24
      recovery_cache_timeout: minutes=5
      recovery_max_attempts: 5
    state: present

  - model: authentik_stages_email.emailstage
    identifiers:
      name: avatar-recovery-email
    attrs:
      name: avatar-recovery-email
      subject: Avatar - Reset password
      template: custom/email_password_reset.html
      activate_user_on_success: true
      from_address: system@authentik.local
      host: localhost
      port: 25
      use_global_settings: true
      timeout: 10
      token_expiry: minutes=30
      recovery_cache_timeout: minutes=5
      recovery_max_attempts: 5
    state: present

  # ========================================
  # IDENTIFICATION STAGES
  # ========================================

  - model: authentik_stages_identification.identificationstage
    identifiers:
      name: avatar-authentication-stage
    attrs:
      name: avatar-authentication-stage
      user_fields:
        - username
        - email
      case_insensitive_matching: true
      show_matched_user: true
      pretend_user_exists: true
      enrollment_flow:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      recovery_flow: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    state: present

  # ========================================
  # PASSWORD STAGES
  # ========================================

  - model: authentik_stages_password.passwordstage
    identifiers:
      name: avatar-password-stage
    attrs:
      name: avatar-password-stage
      backends:
        - authentik.core.auth.InbuiltBackend
        - authentik.core.auth.TokenBackend
        - authentik.sources.ldap.auth.LDAPBackend
        - authentik.sources.kerberos.auth.KerberosBackend
      configure_flow:
        !Find [authentik_flows.flow, [slug, default-password-change]]
      failed_attempts_before_cancel: 5
      allow_show_password: true
    state: present

  # ========================================
  # PROMPT FIELDS
  # ========================================

  - model: authentik_stages_prompt.prompt
    identifiers:
      field_key: password
      name: avatar-initial-setup-field-password
    attrs:
      name: avatar-initial-setup-field-password
      field_key: password
      label: Password
      type: password
      required: true
      placeholder: Password
      order: 300
    state: present

  # ========================================
  # PROMPT STAGES
  # ========================================

  - model: authentik_stages_prompt.promptstage
    identifiers:
      name: avatar-signup-password-ask
    attrs:
      name: avatar-signup-password-ask
      fields:
        - !Find [authentik_stages_prompt.prompt, [field_key, password]]
      validation_policies:
        - !Find [
            authentik_policies_password.passwordpolicy,
            [name, avatar-password-length-policy],
          ]
    state: present

  # ========================================
  # USER WRITE STAGES
  # ========================================

  - model: authentik_stages_user_write.userwritestage
    identifiers:
      name: avatar-self-service-userinfo-write
    attrs:
      name: avatar-self-service-userinfo-write
      user_creation_mode: create_when_required
      create_users_as_inactive: true
      user_path_template: users/self-service
      user_type: external
    state: present

  # ========================================
  # FLOW STAGE BINDINGS - Authentication Flow
  # ========================================

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      stage:
        !Find [
          authentik_stages_identification.identificationstage,
          [name, avatar-authentication-stage],
        ]
      order: 10
    attrs:
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      stage:
        !Find [
          authentik_stages_identification.identificationstage,
          [name, avatar-authentication-stage],
        ]
      order: 10
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      stage:
        !Find [
          authentik_stages_password.passwordstage,
          [name, avatar-password-stage],
        ]
      order: 20
    attrs:
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      stage:
        !Find [
          authentik_stages_password.passwordstage,
          [name, avatar-password-stage],
        ]
      order: 20
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      stage:
        !Find [
          authentik_stages_user_login.userloginstage,
          [name, default-authentication-login],
        ]
      order: 30
    attrs:
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      stage:
        !Find [
          authentik_stages_user_login.userloginstage,
          [name, default-authentication-login],
        ]
      order: 30
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  # ========================================
  # FLOW STAGE BINDINGS - Signup Flow
  # ========================================

  - model: authentik_flows.flowstagebinding
    identifiers:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_prompt.promptstage,
          [name, default-source-enrollment-prompt],
        ]
      order: 10
    attrs:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_prompt.promptstage,
          [name, default-source-enrollment-prompt],
        ]
      order: 10
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_user_write.userwritestage,
          [name, avatar-self-service-userinfo-write],
        ]
      order: 20
    attrs:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_user_write.userwritestage,
          [name, avatar-self-service-userinfo-write],
        ]
      order: 20
      re_evaluate_policies: true
      policy_engine_mode: all
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_email.emailstage,
          [name, avatar-email-account-confirmation],
        ]
      order: 30
    attrs:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_email.emailstage,
          [name, avatar-email-account-confirmation],
        ]
      order: 30
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_prompt.promptstage,
          [name, avatar-signup-password-ask],
        ]
      order: 35
    attrs:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_prompt.promptstage,
          [name, avatar-signup-password-ask],
        ]
      order: 35
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_user_write.userwritestage,
          [name, avatar-self-service-userinfo-write],
        ]
      order: 40
    attrs:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      stage:
        !Find [
          authentik_stages_user_write.userwritestage,
          [name, avatar-self-service-userinfo-write],
        ]
      order: 40
      re_evaluate_policies: true
      policy_engine_mode: all
      invalid_response_action: retry
    state: present

  # ========================================
  # FLOW STAGE BINDINGS - Recovery Flow
  # ========================================

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [
          authentik_stages_identification.identificationstage,
          [name, default-recovery-identification],
        ]
      order: 10
    attrs:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [
          authentik_stages_identification.identificationstage,
          [name, default-recovery-identification],
        ]
      order: 10
      evaluate_on_plan: true
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [authentik_stages_email.emailstage, [name, avatar-recovery-email]]
      order: 20
    attrs:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [authentik_stages_email.emailstage, [name, avatar-recovery-email]]
      order: 20
      evaluate_on_plan: true
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [
          authentik_stages_prompt.promptstage,
          [name, avatar-signup-password-ask],
        ]
      order: 30
    attrs:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [
          authentik_stages_prompt.promptstage,
          [name, avatar-signup-password-ask],
        ]
      order: 30
      re_evaluate_policies: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [
          authentik_stages_user_write.userwritestage,
          [name, default-recovery-user-write],
        ]
      order: 40
    attrs:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [
          authentik_stages_user_write.userwritestage,
          [name, default-recovery-user-write],
        ]
      order: 40
      evaluate_on_plan: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [
          authentik_stages_user_login.userloginstage,
          [name, default-authentication-login],
        ]
      order: 100
    attrs:
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      stage:
        !Find [
          authentik_stages_user_login.userloginstage,
          [name, default-authentication-login],
        ]
      order: 100
      evaluate_on_plan: true
      policy_engine_mode: any
      invalid_response_action: retry
    state: present

  # ========================================
  # POLICY BINDINGS
  # ========================================

  - model: authentik_policies.policybinding
    identifiers:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      policy:
        !Find [
          authentik_policies_expression.expressionpolicy,
          [name, avatar-self-service-per-user-organization-creation],
        ]
      order: 0
    attrs:
      target:
        !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      policy:
        !Find [
          authentik_policies_expression.expressionpolicy,
          [name, avatar-self-service-per-user-organization-creation],
        ]
      enabled: true
      order: 0
      timeout: 30
    state: present

  # ========================================
  # OAUTH2 PROVIDER
  # ========================================

  - model: authentik_providers_oauth2.oauth2provider
    identifiers:
      name: !Format ["Provider for %s", !Context app_name]
    attrs:
      name: !Format ["Provider for %s", !Context app_name]
      client_type: confidential
      client_id: "c199fe03af1cbbb725a1535be7a3427244d67548f289b26822d697fa370161a2"
      client_secret: "7490f4eebbd267692192d2dc04cf061f0eb471cd2ce513a4189a701f55956ea6"

      # Token validity settings
      access_code_validity: minutes=1
      access_token_validity: minutes=5
      refresh_token_validity: days=30
      refresh_token_threshold: hours=1

      # Flow configuration - using custom Avatar flows
      authentication_flow:
        !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      authorization_flow:
        !Find [
          authentik_flows.flow,
          [slug, default-provider-authorization-implicit-consent],
        ]
      invalidation_flow:
        !Find [authentik_flows.flow, [slug, default-invalidation-flow]]

      # OAuth2 settings
      include_claims_in_id_token: true
      issuer_mode: per_provider
      logout_method: backchannel
      sub_mode: user_uuid

      # Redirect URIs
      redirect_uris:
        - matching_mode: strict
          url: "https://avatar.internal.com/api/login/sso/auth"

      # Property mappings - using !Find to reference standard OIDC scopes
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
        - !Find [
            authentik_providers_oauth2.scopemapping,
            [scope_name, offline_access],
          ]
        - !Find [
            authentik_providers_oauth2.scopemapping,
            [scope_name, octopize:license],
          ]

      # Signing key - reference to certificate
      signing_key:
        !Find [
          authentik_crypto.certificatekeypair,
          [name, authentik Self-signed Certificate],
        ]
    state: present

  # ========================================
  # CUSTOM SCOPE MAPPING - License Information
  # ========================================

  - model: authentik_providers_oauth2.scopemapping
    identifiers:
      scope_name: octopize:license
    attrs:
      name: "Octopize License Scope"
      description: "Grab license from the user group"
      scope_name: octopize:license
      expression: |
        # Extract license type from user's primary group attributes
        license_value = "demo"  # Default fallback

        for group in request.user.ak_groups.all():
            if group.attributes.get("license"):
                license_value = group.attributes.get("license")
                break

        return {
            "license": license_value
        }
    state: present

  # ========================================
  # APPLICATION
  # ========================================

  - model: authentik_core.application
    identifiers:
      slug: avatar-api
    attrs:
      name: !Context app_name
      slug: avatar-api
      meta_launch_url: !Format ["https://%s/web", !Context domain]
      policy_engine_mode: any
      provider:
        !Find [
          authentik_providers_oauth2.oauth2provider,
          [name, !Format ["Provider for %s", !Context app_name]],
        ]
    state: present

  # ========================================
  # BRAND CONFIGURATION (bind custom flows to default brand)
  # ========================================

  - model: authentik_brands.brand
    identifiers:
      domain: !Context domain
    attrs:
      domain: !Context domain
      default: true
      branding_title: "Avatar"
      branding_logo: brand_logo.png
      branding_favicon: favicon.ico
      branding_default_flow_background: background.png

      # Application configuration
      default_application:
        !Find [authentik_core.application, [slug, avatar-api]]

      # Bind to custom Avatar flows
      flow_authentication:
        !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      flow_invalidation:
        !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      flow_recovery: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      flow_user_settings:
        !Find [authentik_flows.flow, [slug, default-user-settings-flow]]
    state: present

# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
---
# Octopize Avatar - Authentik Blueprint Template
# This blueprint configures SSO authentication for the Avatar API platform
# including custom flows, stages, policies, and email templates
#
# Required Placeholders (fill before import):
#   avatar.internal.com                - Base domain (e.g., staging.octopize.tech)
#   81a2e49de874abd0cfa0dcf35ee49a0137cf28e2ebd80bfddd6ee0ca9919d830             - OAuth2 Client ID
#   a8296ec6472a92e0ffc643b7d38bf3720b31d689763c3537e12588e21330c44a         - OAuth2 Client Secret
#   https://avatar.internal.com/api/login/sso/auth      - Full redirect URI for API (e.g., https://avatar.internal.com/api/login/sso/auth)
#   demo  - License type for self-service signups (e.g., demo, trial, full)

context:
  app_name: !Context [app_name, Avatar API]
  domain: !Context [domain, 'avatar.internal.com']
  license_type: !Context [license_type, full]
metadata:
  name: octopize-avatar-sso-configuration
version: 1
entries:

# ============================================================
# GROUPS
# ============================================================
  - attrs:
      attributes:
        license: !Context [license_type]
      is_superuser: true
      name: Octopize - Admins
    identifiers:
      name: Octopize - Admins
    model: authentik_core.group
    state: present
  - attrs:
      attributes:
        license: !Context [license_type]
      name: Octopize - Users
    identifiers:
      name: Octopize - Users
    model: authentik_core.group
    state: present

# ============================================================
# FLOWS
# ============================================================
  - attrs:
      authentication: none
      compatibility_mode: true
      denied_action: message_continue
      designation: enrollment
      layout: stacked
      name: avatar-self-service-signup-flow
      policy_engine_mode: any
      slug: avatar-self-service-signup-flow
      title: Self-service signup for Avatar
    identifiers:
      slug: avatar-self-service-signup-flow
    model: authentik_flows.flow
    state: present
  - attrs:
      authentication: require_unauthenticated
      background: /static/dist/assets/images/flow_background.jpg
      denied_action: message_continue
      designation: recovery
      layout: stacked
      name: Default recovery flow
      policy_engine_mode: any
      slug: avatar-recovery-flow
      title: Reset your password
    identifiers:
      slug: avatar-recovery-flow
    model: authentik_flows.flow
    state: present
  - attrs:
      authentication: none
      compatibility_mode: true
      denied_action: message_continue
      designation: authentication
      layout: stacked
      name: avatar-authentication-flow
      policy_engine_mode: any
      slug: avatar-authentication-flow
      title: Avatar authentication
    identifiers:
      slug: avatar-authentication-flow
    model: authentik_flows.flow
    state: present

# ============================================================
# FLOW STAGE BINDINGS
# ============================================================

  # ========================================
  # FLOW STAGE BINDINGS - Authentication Flow
  # ========================================
  - attrs:
      invalid_response_action: retry
      order: 10
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_identification.identificationstage, [name, avatar-authentication-stage]]
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
    identifiers:
      order: 10
      stage: !Find [authentik_stages_identification.identificationstage, [name, avatar-authentication-stage]]
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 20
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_password.passwordstage, [name, avatar-password-stage]]
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
    identifiers:
      order: 20
      stage: !Find [authentik_stages_password.passwordstage, [name, avatar-password-stage]]
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 30
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_user_login.userloginstage, [name, default-authentication-login]]
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
    identifiers:
      order: 30
      stage: !Find [authentik_stages_user_login.userloginstage, [name, default-authentication-login]]
      target: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
    model: authentik_flows.flowstagebinding
    state: present

  # ========================================
  # FLOW STAGE BINDINGS - Recovery Flow
  # ========================================
  - attrs:
      evaluate_on_plan: true
      invalid_response_action: retry
      order: 10
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_identification.identificationstage, [name, default-recovery-identification]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    identifiers:
      order: 10
      stage: !Find [authentik_stages_identification.identificationstage, [name, default-recovery-identification]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      evaluate_on_plan: true
      invalid_response_action: retry
      order: 20
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_email.emailstage, [name, avatar-recovery-email]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    identifiers:
      order: 20
      stage: !Find [authentik_stages_email.emailstage, [name, avatar-recovery-email]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 30
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_prompt.promptstage, [name, avatar-signup-password-ask]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    identifiers:
      order: 30
      stage: !Find [authentik_stages_prompt.promptstage, [name, avatar-signup-password-ask]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      evaluate_on_plan: true
      invalid_response_action: retry
      order: 40
      policy_engine_mode: any
      stage: !Find [authentik_stages_user_write.userwritestage, [name, default-recovery-user-write]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    identifiers:
      order: 40
      stage: !Find [authentik_stages_user_write.userwritestage, [name, default-recovery-user-write]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      evaluate_on_plan: true
      invalid_response_action: retry
      order: 100
      policy_engine_mode: any
      stage: !Find [authentik_stages_user_login.userloginstage, [name, default-recovery-user-login]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    identifiers:
      order: 100
      stage: !Find [authentik_stages_user_login.userloginstage, [name, default-recovery-user-login]]
      target: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
    model: authentik_flows.flowstagebinding
    state: present

  # ========================================
  # FLOW STAGE BINDINGS - Self Service Signup Flow
  # ========================================
  - attrs:
      invalid_response_action: retry
      order: 10
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_prompt.promptstage, [name, default-source-enrollment-prompt]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    identifiers:
      order: 10
      stage: !Find [authentik_stages_prompt.promptstage, [name, default-source-enrollment-prompt]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 20
      policy_engine_mode: all
      re_evaluate_policies: true
      stage: !Find [authentik_stages_user_write.userwritestage, [name, avatar-self-service-userinfo-write]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    identifiers:
      order: 20
      stage: !Find [authentik_stages_user_write.userwritestage, [name, avatar-self-service-userinfo-write]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 30
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_email.emailstage, [name, avatar-email-account-confirmation]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    identifiers:
      order: 30
      stage: !Find [authentik_stages_email.emailstage, [name, avatar-email-account-confirmation]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 35
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_prompt.promptstage, [name, avatar-signup-password-ask]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    identifiers:
      order: 35
      stage: !Find [authentik_stages_prompt.promptstage, [name, avatar-signup-password-ask]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 40
      policy_engine_mode: all
      re_evaluate_policies: true
      stage: !Find [authentik_stages_user_write.userwritestage, [name, avatar-self-service-userinfo-write]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    identifiers:
      order: 40
      stage: !Find [authentik_stages_user_write.userwritestage, [name, avatar-self-service-userinfo-write]]
      target: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
    model: authentik_flows.flowstagebinding
    state: present

# ============================================================
# STAGES
# ============================================================
  - attrs:
      from_address: system@authentik.local
      host: localhost
      name: avatar-email-someone-tried-to-register-with-your-mail
      port: 25
      recovery_cache_timeout: minutes=5
      recovery_max_attempts: 5
      subject: Someone tried to register with your mail
      template: custom/email_account_exists.html
      timeout: 10
      token_expiry: minutes=0
      use_global_settings: true
    identifiers:
      name: avatar-email-someone-tried-to-register-with-your-mail
    model: authentik_stages_email.emailstage
    state: present
  - attrs:
      activate_user_on_success: true
      from_address: system@authentik.local
      host: localhost
      name: avatar-email-account-confirmation
      port: 25
      recovery_cache_timeout: minutes=5
      recovery_max_attempts: 5
      subject: Avatar - Account confirmation
      template: custom/email_account_confirmation.html
      timeout: 10
      token_expiry: hours=24
      use_global_settings: true
    identifiers:
      name: avatar-email-account-confirmation
    model: authentik_stages_email.emailstage
    state: present
  - attrs:
      activate_user_on_success: true
      from_address: system@authentik.local
      host: localhost
      name: avatar-recovery-email
      port: 25
      recovery_cache_timeout: minutes=5
      recovery_max_attempts: 5
      subject: Avatar - Reset password
      template: custom/email_password_reset.html
      timeout: 10
      token_expiry: minutes=30
      use_global_settings: true
    identifiers:
      name: avatar-recovery-email
    model: authentik_stages_email.emailstage
    state: present
  - attrs:
      case_insensitive_matching: true
      enrollment_flow: !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]]
      name: avatar-authentication-stage
      pretend_user_exists: true
      recovery_flow: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      show_matched_user: true
      user_fields:
      - username
      - email
    identifiers:
      name: avatar-authentication-stage
    model: authentik_stages_identification.identificationstage
    state: present
  - attrs:
      allow_show_password: true
      backends:
      - authentik.core.auth.InbuiltBackend
      - authentik.core.auth.TokenBackend
      - authentik.sources.ldap.auth.LDAPBackend
      - authentik.sources.kerberos.auth.KerberosBackend
      configure_flow: !Find [authentik_flows.flow, [slug, default-password-change]]
      failed_attempts_before_cancel: 5
      name: avatar-password-stage
    identifiers:
      name: avatar-password-stage
    model: authentik_stages_password.passwordstage
    state: present
  - attrs:
      fields:
      - !Find [authentik_stages_prompt.prompt, [field_key, password, name, avatar-initial-setup-field-password]]
      name: avatar-signup-password-ask
      validation_policies:
      - !Find [authentik_policies_password.passwordpolicy, [name, avatar-password-length-policy]]
    identifiers:
      name: avatar-signup-password-ask
    model: authentik_stages_prompt.promptstage
    state: present
  - attrs:
      create_users_as_inactive: true
      name: avatar-self-service-userinfo-write
      user_creation_mode: create_when_required
      user_path_template: users/self-service
      user_type: external
    identifiers:
      name: avatar-self-service-userinfo-write
    model: authentik_stages_user_write.userwritestage
    state: present

# ============================================================
# PROMPTS
# ============================================================
  - attrs:
      field_key: password
      label: Password
      name: avatar-initial-setup-field-password
      order: 300
      placeholder: Password
      required: true
      type: password
    identifiers:
      field_key: password
      name: avatar-initial-setup-field-password
    model: authentik_stages_prompt.prompt
    state: present

# ============================================================
# POLICIES
# ============================================================
  - attrs:
      expression: 'from authentik.core.models import User
        email = context.get("prompt_data", {}).get("email")
        user_exists = User.objects.filter(email__iexact=email).exists()
        # Store the result in the flow context for the next stages to use
        context["user_already_exists"] = user_exists
        # Always return True so the attacker doesn''t get an error message
        return True'
      name: check-email-exists-silently
    identifiers:
      name: check-email-exists-silently
    model: authentik_policies_expression.expressionpolicy
    state: present
  - attrs:
      expression: '# Check if the ''user_already_exists'' flag was set to False
        user_exists = context.get("user_already_exists", False)
        return user_exists'
      name: policy-user-already-exists
    identifiers:
      name: policy-user-already-exists
    model: authentik_policies_expression.expressionpolicy
    state: present
  - attrs:
      expression: "from authentik.core.models import Group\n\n# Get the email from the prompt data collected in the first stage\nemail = context.get(\"prompt_data\", {}).get(\"email\")\n\nif email:\n    # Get or create a group with the same suffix as the email\n    group, created = Group.objects.get_or_create(name=f\"self_service-{email}\")\n    \n    # Update the attributes for the group\n    # We use a dictionary update to ensure we don't overwrite other existing attributes\n    if not group.attributes:\n        group.attributes = {}\n        \n    group.attributes[\"license\"] = \"demo\"\n    group.save()\n    \n    # Assign the group object to the flow context\n    # Authentik expects a list of Group objects in the ['groups'] key\n    context[\"flow_plan\"].context[\"groups\"] = [group]\n    \n    if created:\n        ak_logger.info(f\"Created new personal group with demo license for user: {email}\")\n    else:\n        ak_logger.info(f\"Updated existing group attributes for user: {email}\")\n\nreturn True"
      name: avatar-self-service-per-user-organization-creation
    identifiers:
      name: avatar-self-service-per-user-organization-creation
    model: authentik_policies_expression.expressionpolicy
    state: present
  - attrs:
      amount_digits: 0
      amount_lowercase: 0
      amount_symbols: 0
      amount_uppercase: 0
      check_static_rules: true
      error_message: Password must be at least 12 characters long.
      hibp_allowed_count: 0
      length_min: 12
      name: avatar-password-length-policy
      password_field: password
      symbol_charset: '!\"#$%&''()*+,-./:;<=>?@[]^_`{|}~'
      zxcvbn_score_threshold: 2
    identifiers:
      name: avatar-password-length-policy
    model: authentik_policies_password.passwordpolicy
    state: present

# ============================================================
# POLICY BINDINGS
# ============================================================
  - attrs:
      enabled: true
      order: 10
      policy: !Find [authentik_policies_expression.expressionpolicy, [name, avatar-self-service-per-user-organization-creation]]
      target: !Find [authentik_flows.flowstagebinding, [target, !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]], stage, !Find [authentik_stages_user_write.userwritestage, [name, avatar-self-service-userinfo-write]], order, 40]]
      timeout: 30
    identifiers:
      order: 10
      policy: !Find [authentik_policies_expression.expressionpolicy, [name, avatar-self-service-per-user-organization-creation]]
      target: !Find [authentik_flows.flowstagebinding, [target, !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]], stage, !Find [authentik_stages_user_write.userwritestage, [name, avatar-self-service-userinfo-write]], order, 40]]
    model: authentik_policies.policybinding
    state: present
  - attrs:
      enabled: true
      failure_result: true
      order: 5
      policy: !Find [authentik_policies_expression.expressionpolicy, [name, check-email-exists-silently]]
      target: !Find [authentik_flows.flowstagebinding, [target, !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]], stage, !Find [authentik_stages_user_write.userwritestage, [name, avatar-self-service-userinfo-write]], order, 20]]
      timeout: 30
    identifiers:
      order: 5
      policy: !Find [authentik_policies_expression.expressionpolicy, [name, check-email-exists-silently]]
      target: !Find [authentik_flows.flowstagebinding, [target, !Find [authentik_flows.flow, [slug, avatar-self-service-signup-flow]], stage, !Find [authentik_stages_user_write.userwritestage, [name, avatar-self-service-userinfo-write]], order, 20]]
    model: authentik_policies.policybinding
    state: present

# ============================================================
# OAUTH PROVIDER
# ============================================================
  - attrs:
      access_code_validity: minutes=1
      access_token_validity: minutes=5
      authentication_flow: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
      client_id: '81a2e49de874abd0cfa0dcf35ee49a0137cf28e2ebd80bfddd6ee0ca9919d830'
      client_secret: 'a8296ec6472a92e0ffc643b7d38bf3720b31d689763c3537e12588e21330c44a'
      client_type: confidential
      include_claims_in_id_token: true
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      issuer_mode: per_provider
      logout_method: backchannel
      name: !Format [Provider for %s, !Context [app_name]]
      property_mappings:
      - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
      - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
      - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
      - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
      - !Find [authentik_providers_oauth2.scopemapping, [scope_name, offline_access]]
      redirect_uris:
      - matching_mode: strict
        url: 'https://avatar.internal.com/api/login/sso/auth'
      refresh_token_threshold: hours=1
      refresh_token_validity: days=30
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
      sub_mode: user_uuid
    identifiers:
      name: !Format [Provider for %s, !Context [app_name]]
    model: authentik_providers_oauth2.oauth2provider
    state: present

# ============================================================
# SCOPE MAPPINGS
# ============================================================
  - attrs:
      description: Grab license from the user group
      expression: "license = request.user.group_attributes().get('license', None)\n\nif license:\n  return { 'license' : license }"
      name: GrabLicense
      scope_name: profile
    identifiers:
      scope_name: profile
    model: authentik_providers_oauth2.scopemapping
    state: present

# ============================================================
# APPLICATION
# ============================================================
  - attrs:
      meta_launch_url: !Format ['https://%s/web', !Context [domain]]
      name: !Context [app_name]
      policy_engine_mode: any
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, Provider for avatar-api]]
      slug: avatar-api
    identifiers:
      slug: avatar-api
    model: authentik_core.application
    state: present

# ============================================================
# BRAND
# ============================================================
  - attrs:
      branding_default_flow_background: background.png
      branding_favicon: favicon.ico
      branding_logo: brand_logo.png
      branding_title: Avatar
      default: true
      default_application: !Find [authentik_core.application, [slug, avatar-api]]
      domain: !Context [domain]
      flow_authentication: !Find [authentik_flows.flow, [slug, avatar-authentication-flow]]
      flow_invalidation: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      flow_recovery: !Find [authentik_flows.flow, [slug, avatar-recovery-flow]]
      flow_user_settings: !Find [authentik_flows.flow, [slug, default-user-settings-flow]]
    identifiers:
      domain: !Context [domain]
    model: authentik_brands.brand
    state: present

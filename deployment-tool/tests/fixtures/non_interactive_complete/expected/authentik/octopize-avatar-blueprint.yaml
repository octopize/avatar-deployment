# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
---
# Octopize Avatar - Authentik Blueprint Template
# This blueprint configures SSO authentication for the Avatar API platform
# including custom flows, stages, policies, and email templates
#
# Required Placeholders (fill before import):
#   avatar.complete.com                - Base domain (e.g., staging.octopize.tech)
#   598400789d00d62b8ce6bf637b46e4586590b652b31270773d384e8a2913db2e             - OAuth2 Client ID
#   1403272c9f3ba02e39c9211dfa51e17becb8d807e7c9508b0eada7431047f5a6         - OAuth2 Client Secret
#   https://avatar.complete.com/api/login/sso/auth      - Full redirect URI for API (e.g., https://avatar.complete.com/api/login/sso/auth)
#   demo  - License type for self-service signups (e.g., demo, trial, full)

context:
  app_name: Avatar API
  domain: 'avatar.complete.com'
  license_type: full
metadata:
  name: octopize-avatar-sso-configuration
version: 1
entries:

# ============================================================
# GROUPS
# ============================================================
  - attrs:
      attributes:
        license: !Context 'license_type'
      is_superuser: true
      name: Octopize - Admins
    id: octopize---admins
    identifiers:
      name: Octopize - Admins
    model: authentik_core.group
    state: present
  - attrs:
      attributes:
        license: !Context 'license_type'
      name: Octopize - Users
    id: octopize---users
    identifiers:
      name: Octopize - Users
    model: authentik_core.group
    state: present

# ============================================================
# FLOWS
# ============================================================
  - attrs:
      authentication: none
      compatibility_mode: true
      denied_action: message_continue
      designation: enrollment
      layout: stacked
      name: avatar-self-service-signup-flow
      policy_engine_mode: any
      slug: avatar-self-service-signup-flow
      title: Self-service signup for Avatar
    id: avatar-self-service-signup-flow
    identifiers:
      slug: avatar-self-service-signup-flow
    model: authentik_flows.flow
    state: present
  - attrs:
      authentication: require_unauthenticated
      background: /static/dist/assets/images/flow_background.jpg
      denied_action: message_continue
      designation: recovery
      layout: stacked
      name: Default recovery flow
      policy_engine_mode: any
      slug: avatar-recovery-flow
      title: Reset your password
    id: avatar-recovery-flow
    identifiers:
      slug: avatar-recovery-flow
    model: authentik_flows.flow
    state: present
  - attrs:
      authentication: none
      compatibility_mode: true
      denied_action: message_continue
      designation: authentication
      layout: stacked
      name: avatar-authentication-flow
      policy_engine_mode: any
      slug: avatar-authentication-flow
      title: Avatar authentication
    id: avatar-authentication-flow
    identifiers:
      slug: avatar-authentication-flow
    model: authentik_flows.flow
    state: present

# ============================================================
# PROMPTS
# ============================================================
  - attrs:
      field_key: password
      label: Password
      name: default-recovery-field-password
      order: 0
      placeholder: Password
      required: true
      type: password
    id: password
    identifiers:
      field_key: password
      name: default-recovery-field-password
    model: authentik_stages_prompt.prompt
    state: present
  - attrs:
      field_key: password_repeat
      label: Password (repeat)
      name: default-recovery-field-password-repeat
      order: 1
      placeholder: Password (repeat)
      required: true
      type: password
    id: password_repeat
    identifiers:
      field_key: password_repeat
      name: default-recovery-field-password-repeat
    model: authentik_stages_prompt.prompt
    state: present
  - attrs:
      field_key: password
      label: Password
      name: avatar-initial-setup-field-password
      order: 300
      placeholder: Password
      required: true
      type: password
    id: password
    identifiers:
      field_key: password
      name: avatar-initial-setup-field-password
    model: authentik_stages_prompt.prompt
    state: present

# ============================================================
# POLICIES
# ============================================================
  - attrs:
      expression: |-
        from authentik.core.models import User

        email = context.get("prompt_data", {}).get("email")
        user_exists = User.objects.filter(email__iexact=email).exists()

        # Store the result in the flow context for the next stages to use
        context["user_already_exists"] = user_exists

        # Always return True so the attacker doesn't get an error message
        return True
      name: check-email-exists-silently
    id: check-email-exists-silently
    identifiers:
      name: check-email-exists-silently
    model: authentik_policies_expression.expressionpolicy
    state: present
  - attrs:
      expression: |-
        # Check if the 'user_already_exists' flag was set to False
        user_exists = context.get("user_already_exists", False)

        return user_exists
      name: policy-user-already-exists
    id: policy-user-already-exists
    identifiers:
      name: policy-user-already-exists
    model: authentik_policies_expression.expressionpolicy
    state: present
  - attrs:
      expression: |-
        from authentik.core.models import Group

        # Get the email from the prompt data collected in the first stage
        email = context.get("prompt_data", {}).get("email")

        if email:
            # Get or create a group with the same suffix as the email
            group, created = Group.objects.get_or_create(name=f"self_service-{email}")

            # Update the attributes for the group
            # We use a dictionary update to ensure we don't overwrite other existing attributes
            if not group.attributes:
                group.attributes = {}

            group.attributes["license"] = "demo"
            group.save()

            # Assign the group object to the flow context
            # Authentik expects a list of Group objects in the ['groups'] key
            context["flow_plan"].context["groups"] = [group]

            if created:
                ak_logger.info(f"Created new personal group with demo license for user: {email}")
            else:
                ak_logger.info(f"Updated existing group attributes for user: {email}")

        return True
      name: avatar-self-service-per-user-organization-creation
    id: avatar-self-service-per-user-organization-creation
    identifiers:
      name: avatar-self-service-per-user-organization-creation
    model: authentik_policies_expression.expressionpolicy
    state: present
  - attrs:
      amount_digits: 0
      amount_lowercase: 0
      amount_symbols: 0
      amount_uppercase: 0
      check_static_rules: true
      error_message: Password must be at least 12 characters long.
      hibp_allowed_count: 0
      length_min: 12
      name: avatar-password-length-policy
      password_field: password
      symbol_charset: '!\"#$%&''()*+,-./:;<=>?@[]^_`{|}~'
      zxcvbn_score_threshold: 2
    id: avatar-password-length-policy
    identifiers:
      name: avatar-password-length-policy
    model: authentik_policies_password.passwordpolicy
    state: present

# ============================================================
# STAGES
# ============================================================
  - attrs:
      from_address: system@authentik.local
      host: localhost
      name: avatar-email-someone-tried-to-register-with-your-mail
      port: 25
      recovery_cache_timeout: minutes=5
      recovery_max_attempts: 5
      subject: Someone tried to register with your mail
      template: email/email_account_exists.html
      timeout: 10
      token_expiry: minutes=0
      use_global_settings: true
    id: avatar-email-someone-tried-to-register-with-your-mail
    identifiers:
      name: avatar-email-someone-tried-to-register-with-your-mail
    model: authentik_stages_email.emailstage
    state: present
  - attrs:
      activate_user_on_success: true
      from_address: system@authentik.local
      host: localhost
      name: avatar-email-account-confirmation
      port: 25
      recovery_cache_timeout: minutes=5
      recovery_max_attempts: 5
      subject: Avatar - Account confirmation
      template: email/email_account_confirmation.html
      timeout: 10
      token_expiry: hours=24
      use_global_settings: true
    id: avatar-email-account-confirmation
    identifiers:
      name: avatar-email-account-confirmation
    model: authentik_stages_email.emailstage
    state: present
  - attrs:
      activate_user_on_success: true
      from_address: system@authentik.local
      host: localhost
      name: avatar-recovery-email
      port: 25
      recovery_cache_timeout: minutes=5
      recovery_max_attempts: 5
      subject: Avatar - Reset password
      template: email/email_password_reset.html
      timeout: 10
      token_expiry: minutes=30
      use_global_settings: true
    id: avatar-recovery-email
    identifiers:
      name: avatar-recovery-email
    model: authentik_stages_email.emailstage
    state: present
  - attrs:
      case_insensitive_matching: true
      name: default-recovery-identification
      pretend_user_exists: true
      show_matched_user: true
      user_fields:
      - email
      - username
    id: default-recovery-identification
    identifiers:
      name: default-recovery-identification
    model: authentik_stages_identification.identificationstage
    state: present
  - attrs:
      case_insensitive_matching: true
      enrollment_flow: !KeyOf 'avatar-self-service-signup-flow'
      name: avatar-authentication-stage
      pretend_user_exists: true
      recovery_flow: !KeyOf 'avatar-recovery-flow'
      show_matched_user: true
      user_fields:
      - username
      - email
    id: avatar-authentication-stage
    identifiers:
      name: avatar-authentication-stage
    model: authentik_stages_identification.identificationstage
    state: present
  - attrs:
      allow_show_password: true
      backends:
      - authentik.core.auth.InbuiltBackend
      - authentik.core.auth.TokenBackend
      - authentik.sources.ldap.auth.LDAPBackend
      - authentik.sources.kerberos.auth.KerberosBackend
      configure_flow: !Find [authentik_flows.flow, [slug, default-password-change]]
      failed_attempts_before_cancel: 5
      name: avatar-password-stage
    id: avatar-password-stage
    identifiers:
      name: avatar-password-stage
    model: authentik_stages_password.passwordstage
    state: present
  - attrs:
      fields:
      - !KeyOf 'password'
      name: avatar-signup-password-ask
      validation_policies:
      - !KeyOf 'avatar-password-length-policy'
    id: avatar-signup-password-ask
    identifiers:
      name: avatar-signup-password-ask
    model: authentik_stages_prompt.promptstage
    state: present
  - attrs:
      geoip_binding: no_binding
      name: default-recovery-user-login
      network_binding: no_binding
      remember_device: days=30
      remember_me_offset: seconds=0
      session_duration: seconds=0
    id: default-recovery-user-login
    identifiers:
      name: default-recovery-user-login
    model: authentik_stages_user_login.userloginstage
    state: present
  - attrs:
      create_users_as_inactive: true
      name: avatar-self-service-userinfo-write
      user_creation_mode: create_when_required
      user_path_template: users/self-service
      user_type: external
    id: avatar-self-service-userinfo-write
    identifiers:
      name: avatar-self-service-userinfo-write
    model: authentik_stages_user_write.userwritestage
    state: present
  - attrs:
      name: default-recovery-user-write
      user_creation_mode: never_create
      user_type: external
    id: default-recovery-user-write
    identifiers:
      name: default-recovery-user-write
    model: authentik_stages_user_write.userwritestage
    state: present

# ============================================================
# FLOW STAGE BINDINGS
# ============================================================

  # ========================================
  # FLOW STAGE BINDINGS - Authentication Flow
  # ========================================
  - attrs:
      invalid_response_action: retry
      order: 10
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !KeyOf 'avatar-authentication-stage'
      target: !KeyOf 'avatar-authentication-flow'
    id: avatar-authentication-flow-bind-avatar-authentication-stage-order-10
    identifiers:
      order: 10
      stage: !KeyOf 'avatar-authentication-stage'
      target: !KeyOf 'avatar-authentication-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 20
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !KeyOf 'avatar-password-stage'
      target: !KeyOf 'avatar-authentication-flow'
    id: avatar-authentication-flow-bind-avatar-password-stage-order-20
    identifiers:
      order: 20
      stage: !KeyOf 'avatar-password-stage'
      target: !KeyOf 'avatar-authentication-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 30
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_user_login.userloginstage, [name, default-authentication-login]]
      target: !KeyOf 'avatar-authentication-flow'
    id: avatar-authentication-flow-bind-default-authentication-login-order-30
    identifiers:
      order: 30
      stage: !Find [authentik_stages_user_login.userloginstage, [name, default-authentication-login]]
      target: !KeyOf 'avatar-authentication-flow'
    model: authentik_flows.flowstagebinding
    state: present

  # ========================================
  # FLOW STAGE BINDINGS - Recovery Flow
  # ========================================
  - attrs:
      evaluate_on_plan: true
      invalid_response_action: retry
      order: 10
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !KeyOf 'default-recovery-identification'
      target: !KeyOf 'avatar-recovery-flow'
    id: avatar-recovery-flow-bind-default-recovery-identification-order-10
    identifiers:
      order: 10
      stage: !KeyOf 'default-recovery-identification'
      target: !KeyOf 'avatar-recovery-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      evaluate_on_plan: true
      invalid_response_action: retry
      order: 20
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !KeyOf 'avatar-recovery-email'
      target: !KeyOf 'avatar-recovery-flow'
    id: avatar-recovery-flow-bind-avatar-recovery-email-order-20
    identifiers:
      order: 20
      stage: !KeyOf 'avatar-recovery-email'
      target: !KeyOf 'avatar-recovery-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 30
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !KeyOf 'avatar-signup-password-ask'
      target: !KeyOf 'avatar-recovery-flow'
    id: avatar-recovery-flow-bind-avatar-signup-password-ask-order-30
    identifiers:
      order: 30
      stage: !KeyOf 'avatar-signup-password-ask'
      target: !KeyOf 'avatar-recovery-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      evaluate_on_plan: true
      invalid_response_action: retry
      order: 40
      policy_engine_mode: any
      stage: !KeyOf 'default-recovery-user-write'
      target: !KeyOf 'avatar-recovery-flow'
    id: avatar-recovery-flow-bind-default-recovery-user-write-order-40
    identifiers:
      order: 40
      stage: !KeyOf 'default-recovery-user-write'
      target: !KeyOf 'avatar-recovery-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      evaluate_on_plan: true
      invalid_response_action: retry
      order: 100
      policy_engine_mode: any
      stage: !KeyOf 'default-recovery-user-login'
      target: !KeyOf 'avatar-recovery-flow'
    id: avatar-recovery-flow-bind-default-recovery-user-login-order-100
    identifiers:
      order: 100
      stage: !KeyOf 'default-recovery-user-login'
      target: !KeyOf 'avatar-recovery-flow'
    model: authentik_flows.flowstagebinding
    state: present

  # ========================================
  # FLOW STAGE BINDINGS - Self Service Signup Flow
  # ========================================
  - attrs:
      invalid_response_action: retry
      order: 10
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !Find [authentik_stages_prompt.promptstage, [name, default-source-enrollment-prompt]]
      target: !KeyOf 'avatar-self-service-signup-flow'
    id: avatar-self-service-signup-flow-bind-default-source-enrollment-prompt-order-10
    identifiers:
      order: 10
      stage: !Find [authentik_stages_prompt.promptstage, [name, default-source-enrollment-prompt]]
      target: !KeyOf 'avatar-self-service-signup-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 20
      policy_engine_mode: all
      re_evaluate_policies: true
      stage: !KeyOf 'avatar-self-service-userinfo-write'
      target: !KeyOf 'avatar-self-service-signup-flow'
    id: avatar-self-service-signup-flow-bind-avatar-self-service-userinfo-write-order-20
    identifiers:
      order: 20
      stage: !KeyOf 'avatar-self-service-userinfo-write'
      target: !KeyOf 'avatar-self-service-signup-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 30
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !KeyOf 'avatar-email-account-confirmation'
      target: !KeyOf 'avatar-self-service-signup-flow'
    id: avatar-self-service-signup-flow-bind-avatar-email-account-confirmation-order-30
    identifiers:
      order: 30
      stage: !KeyOf 'avatar-email-account-confirmation'
      target: !KeyOf 'avatar-self-service-signup-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 35
      policy_engine_mode: any
      re_evaluate_policies: true
      stage: !KeyOf 'avatar-signup-password-ask'
      target: !KeyOf 'avatar-self-service-signup-flow'
    id: avatar-self-service-signup-flow-bind-avatar-signup-password-ask-order-35
    identifiers:
      order: 35
      stage: !KeyOf 'avatar-signup-password-ask'
      target: !KeyOf 'avatar-self-service-signup-flow'
    model: authentik_flows.flowstagebinding
    state: present
  - attrs:
      invalid_response_action: retry
      order: 40
      policy_engine_mode: all
      re_evaluate_policies: true
      stage: !KeyOf 'avatar-self-service-userinfo-write'
      target: !KeyOf 'avatar-self-service-signup-flow'
    id: avatar-self-service-signup-flow-bind-avatar-self-service-userinfo-write-order-40
    identifiers:
      order: 40
      stage: !KeyOf 'avatar-self-service-userinfo-write'
      target: !KeyOf 'avatar-self-service-signup-flow'
    model: authentik_flows.flowstagebinding
    state: present

# ============================================================
# POLICY BINDINGS
# ============================================================
  - attrs:
      enabled: true
      order: 10
      policy: !KeyOf 'avatar-self-service-per-user-organization-creation'
      target: !KeyOf 'avatar-self-service-signup-flow-bind-avatar-self-service-userinfo-write-order-40'
      timeout: 30
    id: avatar-self-service-per-user-organization-creation-bind-avatar-self-service-signup-flow-bind-avatar-self-service-userinfo-write-order-40-order-10
    identifiers:
      order: 10
      policy: !KeyOf 'avatar-self-service-per-user-organization-creation'
      target: !KeyOf 'avatar-self-service-signup-flow-bind-avatar-self-service-userinfo-write-order-40'
    model: authentik_policies.policybinding
    state: present
  - attrs:
      enabled: true
      failure_result: true
      order: 5
      policy: !KeyOf 'check-email-exists-silently'
      target: !KeyOf 'avatar-self-service-signup-flow-bind-avatar-self-service-userinfo-write-order-20'
      timeout: 30
    id: check-email-exists-silently-bind-avatar-self-service-signup-flow-bind-avatar-self-service-userinfo-write-order-20-order-5
    identifiers:
      order: 5
      policy: !KeyOf 'check-email-exists-silently'
      target: !KeyOf 'avatar-self-service-signup-flow-bind-avatar-self-service-userinfo-write-order-20'
    model: authentik_policies.policybinding
    state: present

# ============================================================
# SCOPE MAPPINGS
# ============================================================
  - attrs:
      description: Grab license from the user group
      expression: |-
        license = request.user.group_attributes().get('license', None)

        if license:
          return { 'license' : license }
      name: GrabLicense
      scope_name: profile
    id: grablicense
    identifiers:
      name: GrabLicense
    model: authentik_providers_oauth2.scopemapping
    state: present

# ============================================================
# OAUTH PROVIDER
# ============================================================
  - attrs:
      access_code_validity: minutes=1
      access_token_validity: minutes=5
      authentication_flow: !KeyOf 'avatar-authentication-flow'
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
      client_id: '598400789d00d62b8ce6bf637b46e4586590b652b31270773d384e8a2913db2e'
      client_secret: '1403272c9f3ba02e39c9211dfa51e17becb8d807e7c9508b0eada7431047f5a6'
      client_type: confidential
      include_claims_in_id_token: true
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      issuer_mode: per_provider
      logout_method: backchannel
      name: !Format [Provider for %s, !Context 'app_name']
      property_mappings:
      - !KeyOf 'grablicense'
      - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
      - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
      - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
      - !Find [authentik_providers_oauth2.scopemapping, [scope_name, offline_access]]
      redirect_uris:
      - matching_mode: strict
        url: 'https://avatar.complete.com/api/login/sso/auth'
      refresh_token_threshold: hours=1
      refresh_token_validity: days=30
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
      sub_mode: user_uuid
    id: provider-for-avatar-api
    identifiers:
      name: !Format [Provider for %s, !Context 'app_name']
    model: authentik_providers_oauth2.oauth2provider
    state: present

# ============================================================
# APPLICATION
# ============================================================
  - attrs:
      meta_launch_url: !Format ['https://%s/web', !Context 'domain']
      name: !Context 'app_name'
      policy_engine_mode: any
      provider: !KeyOf 'provider-for-avatar-api'
      slug: avatar-api
    id: avatar-api
    identifiers:
      slug: avatar-api
    model: authentik_core.application
    state: present

# ============================================================
# BRAND
# ============================================================
  - attrs:
      branding_default_flow_background: background.png
      branding_favicon: favicon.ico
      branding_logo: brand_logo.png
      branding_title: Avatar
      default: false
      default_application: !KeyOf 'avatar-api'
      domain: !Context 'domain'
      flow_authentication: !KeyOf 'avatar-authentication-flow'
      flow_invalidation: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      flow_recovery: !KeyOf 'avatar-recovery-flow'
      flow_user_settings: !Find [authentik_flows.flow, [slug, default-user-settings-flow]]
    id: octopize.tech
    identifiers:
      domain: !Context 'domain'
    model: authentik_brands.brand
    state: present
